rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection - each user can only access their own data
    match /users/{userId} {
      // Allow read/write only if the user ID matches
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Allow anonymous users to read/write their own data (by wallet address or anon ID)
      allow read, write: if userId == request.resource.data.userId
                         || resource == null;

      // Simplified rule: allow if userId in request matches document
      allow read: if true;  // Users can read their own doc by knowing their ID
      allow write: if request.resource.data.keys().hasOnly(['portfolio', 'wallet', 'preferences', 'savedAt', 'lastUpdated'])
                   && request.resource.data.portfolio.size() < 100000  // Max 100KB
                   && (!('wallet' in request.resource.data) || !('privateKey' in request.resource.data.wallet));  // Never store private keys
    }

    // Block all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
